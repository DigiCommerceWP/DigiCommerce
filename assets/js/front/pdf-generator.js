(()=>{document.addEventListener("DOMContentLoaded",function(){let r=document.querySelector(".download-pdf");if(!r){console.error("Download button not found.");return}let D=t=>new Promise((l,c)=>{let o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{let i=document.createElement("canvas");i.width=o.width,i.height=o.height,i.getContext("2d").drawImage(o,0,0),l(i.toDataURL("image/png"))},o.onerror=()=>c(new Error(`Failed to load image: ${t}`)),o.src=t}),h=async()=>{let t=document.getElementById("digicommerce-receipt");if(!t)throw new Error(digicommercePDF.i18n.errorMessage);let l=t.querySelector(".pdf-id")?.textContent.split(":")[1]?.trim()||digicommercePDF.i18n.unknown,c=t.querySelector(".pdf-date")?.textContent.split("Date:")[1]?.trim()||digicommercePDF.i18n.unknown,o=t.querySelector(".pdf-next-date")?.textContent.split("Next Payment:")[1]?.trim()||"",i=t.querySelector(".business-info"),d=i.querySelector(".business-name")?.textContent.trim()||"",m=Array.from(i.querySelectorAll(".business-address span")).map(n=>n.textContent.trim()).filter(Boolean),u=t.querySelector(".billing-info"),g=u.querySelector(".billing-company")?.textContent.trim()||"",x=Array.from(u.querySelectorAll(".billing-address span")).map(n=>n.textContent.trim()).filter(Boolean),b=document.getElementById("digicommerce-receipt-logo"),a=b?b.src:null,f=a?await D(a):null,p=Array.from(t.querySelectorAll(".digicommerce-table:not(.no-invoice) tbody tr")).map(n=>{let s=n.querySelector("td:first-child"),y="";if(s){let S=s.cloneNode(!0);S.querySelectorAll(".no-invoice").forEach(v=>v.remove()),y=S.textContent.trim()}let w=n.querySelector("td:last-child")?.textContent.trim()||digicommercePDF.i18n.unknown;return{product:y||digicommercePDF.i18n.unknown,total:w}}),e=Array.from(t.querySelectorAll(".digicommerce-table tfoot tr")).map(n=>({label:n.querySelector("th")?.textContent.trim()||"",value:n.querySelector("td")?.textContent.trim()||""}));return{pdfNumber:l,pdfDate:c,pdfNextDate:o,businessName:d,businessAddresses:m,billingCompany:g,billingAddresses:x,logoBase64:f,items:p,totals:e}},F=async()=>{try{let f=function(e){let n=document.createElement("div");return n.innerHTML=e,n.querySelectorAll("strong").forEach(s=>{let y=document.createTextNode(s.textContent);s.replaceWith(y)}),n.textContent.trim()};var t=f;let{pdfNumber:l,pdfDate:c,pdfNextDate:o,businessName:i,businessAddresses:d,billingCompany:m,billingAddresses:u,logoBase64:g,items:x,totals:b}=await h(),a=l.replace("#",""),p={content:[{columns:[g?{image:g,width:80}:{text:""},{stack:[{text:`${digicommercePDF.i18n.invoiceId}: ${a}`,style:"invoiceId"},{text:`${digicommercePDF.i18n.date}: ${c}`,style:"invoiceDate"},o?{text:`${digicommercePDF.i18n.nextDate}: ${o}`,style:"invoiceDate"}:null],alignment:"right"}],margin:[0,0,0,20]},{columns:[{stack:[{text:digicommercePDF.i18n.from,style:"subheader"},{text:i,style:"businessName"},...d.map(e=>({text:e}))]},{stack:[{text:digicommercePDF.i18n.billTo,style:"subheader"},m?{text:m,style:"billingName"}:null,...u.map(e=>({text:e}))].filter(Boolean),alignment:"right"}],columnGap:20,margin:[0,0,0,20]},{text:digicommercePDF.i18n.orderDetails,style:"sectionHeader",margin:[0,10,0,10]},{table:{headerRows:1,widths:["*","auto"],body:[[{text:digicommercePDF.i18n.product,style:"tableHeader"},{text:digicommercePDF.i18n.total,style:"tableHeader",alignment:"right"}],...x.map(e=>[{text:e.product,style:"tableData"},{text:e.total,style:"tableData",alignment:"right"}]),...b.map(e=>[{text:e.label,style:e.label.includes("Subtotal")||e.label.includes("VAT")?"tableFooterSmall":"tableFooterBold"},{text:e.value,alignment:"right",style:e.label.includes("Subtotal")||e.label.includes("VAT")?"tableFooterSmall":e.label.includes("Total")?"tableFooterGreen":"tableFooterBold"}])]},layout:"lightHorizontalLines"}],footer:{columns:[{stack:[{text:i+`
`,style:"footerBusiness"},{text:f(digicommercePDF.i18n.allRightsReserved),style:"footerText"}],alignment:"center",width:"*"}],margin:[40,20]},styles:{invoiceId:{fontSize:18,bold:!0,color:"#09053A",margin:[0,0,0,5]},invoiceDate:{fontSize:12,color:"#656071"},subheader:{fontSize:16,bold:!0,color:"#09053A",margin:[0,5,0,5]},sectionHeader:{fontSize:15,bold:!0,color:"#09053A"},tableHeader:{fontSize:16,bold:!0,color:"#09053A"},tableData:{fontSize:11},tableFooter:{fontSize:11,bold:!1},tableFooterSmall:{fontSize:11,bold:!0,color:"#09053A"},tableFooterBold:{fontSize:16,bold:!0},tableFooterGreen:{fontSize:16,bold:!0,color:"#16a34a"},businessName:{fontSize:16,bold:!0,color:"#09053A"},billingName:{fontSize:16,bold:!0,color:"#09053A"},footerBusiness:{fontSize:10,bold:!0,color:"#09053A"},footerText:{fontSize:8,color:"#656071"}},pageMargins:[40,40,40,80],defaultStyle:{fontSize:11,lineHeight:1.4}};pdfMake.createPdf(p).download(`${digicommercePDF.i18n.invoice}-${a}.pdf`)}catch(l){console.error("Error generating PDF:",l),alert(digicommercePDF.i18n.errorMessage||"An error occurred while generating the PDF.")}};r.addEventListener("click",async function(t){t.preventDefault();let l=r.querySelector(".text").innerHTML,c=r.querySelector(".icon").innerHTML;r.querySelector(".text").textContent=digicommercePDF.i18n.generating,r.querySelector(".icon").innerHTML='<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor"><path opacity=".4" d="M0 256C0 114.9 114.1 .5 255.1 0C237.9 .5 224 14.6 224 32c0 17.7 14.3 32 32 32C150 64 64 150 64 256s86 192 192 192c69.7 0 130.7-37.1 164.5-92.6c-3 6.6-3.3 14.8-1 22.2c1.2 3.7 3 7.2 5.4 10.3c1.2 1.5 2.6 3 4.1 4.3c.8 .7 1.6 1.3 2.4 1.9c.4 .3 .8 .6 1.3 .9s.9 .6 1.3 .8c5 2.9 10.6 4.3 16 4.3c11 0 21.8-5.7 27.7-16c-44.3 76.5-127 128-221.7 128C114.6 512 0 397.4 0 256z"/><path d="M224 32c0-17.7 14.3-32 32-32C397.4 0 512 114.6 512 256c0 46.6-12.5 90.4-34.3 128c-8.8 15.3-28.4 20.5-43.7 11.7s-20.5-28.4-11.7-43.7c16.3-28.2 25.7-61 25.7-96c0-106-86-192-192-192c-17.7 0-32-14.3-32-32z"/></svg>',r.disabled=!0;try{await F()}catch(o){console.error("Error:",o),alert(digicommercePDF.i18n.errorMessage)}finally{r.querySelector(".text").innerHTML=l,r.querySelector(".icon").innerHTML=c,r.disabled=!1}})});})();
