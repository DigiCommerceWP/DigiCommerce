(()=>{var u=class{constructor(){if(this.form=document.getElementById("digicommerce-checkout-form"),this.countrySelect=document.getElementById("country"),this.vatNumberField=document.getElementById("vat_number_field"),this.vatNumberInput=document.getElementById("vat_number"),this.cartVatElement=document.getElementById("cart-vat"),this.cartTotalElement=document.getElementById("cart-total"),this.vatSection=document.getElementById("vat_section"),this.cartSubtotalElement=document.getElementById("cart-subtotal"),this.discountType=null,this.subtotalValue=0,this.discountAmount=0,this.businessCountry=digicommerceVars.businessCountry,!(!this.form||!this.countrySelect||!this.cartSubtotalElement)){try{this.taxRates=JSON.parse(this.form.dataset.taxRates||"{}")}catch(t){console.warn("Invalid tax rates JSON:",t),this.taxRates={}}this.initializeEventListeners(),this.updateFromSubtotal()}}initializeEventListeners(){this.countrySelect&&this.countrySelect.addEventListener("change",()=>{this.updateFromSubtotal()}),this.vatNumberInput&&this.vatNumberInput.addEventListener("input",()=>{this.updateFromSubtotal()})}updateFromSubtotal(){if(!this.cartSubtotalElement)return;let t=this.cartSubtotalElement.querySelector(".subtotal-price .price");t&&(this.subtotalValue=parseFloat(t.textContent.replace(/[^0-9.-]+/g,""))||0,this.cartTotalElement&&(this.discountAmount=parseFloat(this.cartTotalElement.dataset.discountRaw||0),this.discountType=this.cartTotalElement.dataset.discountType||"fixed"),this.updateVATDisplay(this.countrySelect.value))}isEUCountry(t){return this.taxRates[t]?.eu===!0}validateVATNumber(t,i){if(!t||(t=t.toUpperCase().replace(/[^A-Z0-9]/g,""),!this.isEUCountry(i)))return!1;if(!t.startsWith(i))return this.vatNumberInput&&(this.vatNumberInput.setCustomValidity(digicommerceVars.i18n.vat_number),this.vatNumberInput.reportValidity()),!1;if(t.length<8)return this.vatNumberInput&&(this.vatNumberInput.setCustomValidity(digicommerceVars.i18n.vat_short),this.vatNumberInput.reportValidity()),!1;let s={AT:/^ATU[0-9]{8}$/,BE:/^BE[0-9]{10}$/,BG:/^BG[0-9]{9,10}$/,CY:/^CY[0-9]{8}[A-Z]$/,CZ:/^CZ[0-9]{8,10}$/,DE:/^DE[0-9]{9}$/,DK:/^DK[0-9]{8}$/,EE:/^EE[0-9]{9}$/,EL:/^EL[0-9]{9}$/,ES:/^ES[A-Z0-9][0-9]{7}[A-Z0-9]$/,FI:/^FI[0-9]{8}$/,FR:/^FR[0-9A-Z]{2}[0-9]{9}$/,HR:/^HR[0-9]{11}$/,HU:/^HU[0-9]{8}$/,IE:/^IE[0-9][A-Z0-9][0-9]{5}[A-Z]$/,IT:/^IT[0-9]{11}$/,LT:/^LT([0-9]{9}|[0-9]{12})$/,LU:/^LU[0-9]{8}$/,LV:/^LV[0-9]{11}$/,MT:/^MT[0-9]{8}$/,NL:/^NL[0-9]{9}B[0-9]{2}$/,PL:/^PL[0-9]{10}$/,PT:/^PT[0-9]{9}$/,RO:/^RO[0-9]{2,10}$/,SE:/^SE[0-9]{12}$/,SI:/^SI[0-9]{8}$/,SK:/^SK[0-9]{10}$/};return s[i]&&!s[i].test(t)?(this.vatNumberInput&&(this.vatNumberInput.setCustomValidity(digicommerceVars.i18n.vat_invalid+i),this.vatNumberInput.reportValidity()),!1):(this.vatNumberInput&&this.vatNumberInput.setCustomValidity(""),!0)}updateVATDisplay(t){let i=this.taxRates[t]||{rate:0,eu:!1},s=this.taxRates[this.businessCountry]?.rate||0,l=parseFloat(i.rate)||0,c=this.isEUCountry(t),n=t===this.businessCountry,a=0,m=this.vatNumberInput?this.vatNumberInput.value.trim():"";this.vatNumberField&&(this.vatNumberField.style.display=c&&!n?"block":"none");let r=this.subtotalValue;n?a=r*s:c&&(m&&this.validateVATNumber(m,t)||(a=r*l));let d=r+a,E=Math.max(0,d-this.discountAmount);a=Math.round(a*100)/100;let h=Math.round(E*100)/100;if(this.cartVatElement){let e=this.cartVatElement.querySelector(".vat-price .price");e&&(e.textContent=a.toFixed(2))}if(this.cartTotalElement){let e=this.cartTotalElement.querySelector(".total-price .price");e&&(e.textContent=h.toFixed(2)),this.cartTotalElement.dataset.currentTotal=h}let o=document.getElementById("vat_rate");if(o)if(a>0){let e=n?s:l;o.textContent=`(${(e*100).toFixed(2)}%)`}else o.textContent="(0%)"}};document.addEventListener("DOMContentLoaded",()=>{window.vatCalculator=new u});})();
