(()=>{var c={showMessage:(e,a,d=!0)=>{e.textContent=a,e.classList.remove("hidden","bg-green-500","bg-red-500"),e.classList.add(d?"bg-red-500":"bg-green-500","text-white");let u=e.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:u,behavior:"smooth"})},hideMessage:(e,a=5e3)=>{setTimeout(()=>{e.classList.add("hidden")},a)},toggleLoading:(e,a)=>{a?(e.classList.remove("hidden"),e.classList.add("flex")):(e.classList.add("hidden"),e.classList.remove("flex"))},resetButton:(e,a)=>{e.disabled=!1,e.textContent=a},handleValidationFailure:(e,a,d,_,u)=>{c.showMessage(e,u),c.toggleLoading(a,!1),c.resetButton(d,_)}},q={async handlePayment(e,a,d){try{let u=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_process_stripe_payment",nonce:e.get("checkout_nonce"),...this.getFormFields(e)})})).json();if(!u.success)throw new Error(u.data?.message||"Payment setup failed");let L={payment_method:{card:a,billing_details:this.getBillingDetails(e)}},g={customer_id:u.data.customerId},h=u.data.setupIntent!==void 0;if(u.data.setupIntent){let{setupIntent:p,error:r}=await d.confirmCardSetup(u.data.setupIntent.client_secret,L);if(r)throw new Error(r.message);g.payment_method=p.payment_method,g.setup_intent_id=p.id}if(u.data.paymentIntent){let p=g.payment_method?{payment_method:g.payment_method}:L,{paymentIntent:r,error:b}=await d.confirmCardPayment(u.data.paymentIntent.client_secret,p);if(b)throw new Error(b.message);g.payment_intent_id=r.id,g.payment_method||(g.payment_method=r.payment_method)}if(g.payment_method&&h&&g.setup_intent_id){let r=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_process_stripe_payment",nonce:e.get("checkout_nonce"),stripe_payment_data:JSON.stringify(g),...this.getFormFields(e)})})).json();if(!r.success)throw new Error(r.data?.message||"Failed to create subscription");if(r.data.requiresAction&&r.data.clientSecret){let{paymentIntent:b,error:I}=await d.confirmCardPayment(r.data.clientSecret);if(I)throw new Error(I.message);g.payment_intent_id=b.id}r.data.subscriptionId&&(g.subscription_id=r.data.subscriptionId)}return await this.processCheckout(new URLSearchParams({action:"digicommerce_process_checkout",checkout_nonce:e.get("checkout_nonce"),payment_method:"stripe",stripe_payment_data:JSON.stringify(g),...this.getFormFields(e)}))}catch(_){throw console.error("Payment error:",_),_}},processCheckout(e){return fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(a=>a.json()).then(a=>{if(!a.success)throw new Error(a.data?.message||"Checkout processing failed");return a})},getBillingDetails(e){return{name:`${e.get("billing_first_name")} ${e.get("billing_last_name")}`,email:e.get("billing_email"),phone:e.get("billing_phone"),address:{line1:e.get("billing_address"),city:e.get("billing_city"),postal_code:e.get("billing_postcode"),country:e.get("billing_country")}}},getFormFields(e){let a={first_name:e.get("billing_first_name"),last_name:e.get("billing_last_name"),email:e.get("billing_email"),phone:e.get("billing_phone"),company:e.get("billing_company")||"",address:e.get("billing_address"),city:e.get("billing_city"),postcode:e.get("billing_postcode"),country:e.get("billing_country"),vat_number:e.get("billing_vat_number")||""},d=document.getElementById("subscribe_mailing_list");d&&(a.subscribe_mailing_list=d.checked?"1":"0");let _=new URLSearchParams(window.location.search);return _.get("from_abandoned")==="1"&&(a.from_abandoned="1",_.get("coupon")&&(a.recovery_coupon=_.get("coupon"))),a}},k,x;document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("digicommerce-checkout-form"),a=new URLSearchParams(window.location.search);if(e&&(digicommerceVars.stripeEnabled&&(k=Stripe(digicommerceVars.publishableKey),x=k.elements().create("card",{hidePostalCode:!0,style:{base:{fontSize:"16px",color:"#32325d",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',"::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}}),x.mount("#card-element"),x.addEventListener("change",function(t){let o=document.getElementById("card-errors");t.error?(o.textContent=t.error.message,o.classList.remove("hidden"),o.classList.add("flex")):(o.textContent="",o.classList.remove("flex"),o.classList.add("hidden"))})),digicommerceVars.paypalEnabled)){let i=JSON.parse(digicommerceVars.cartItems||"[]"),t=i.some(l=>l.subscription_enabled),o=t?i.find(l=>l.subscription_enabled):null,y={fundingSource:paypal.FUNDING.PAYPAL,style:{layout:"vertical",shape:"rect",label:t?"subscribe":"pay"}};t?y.createSubscription=async(l,v)=>{try{if(!e)throw new Error("Checkout form not found");let n=new FormData(e);c.toggleLoading(document.getElementById("loading-overlay"),!0);let m=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_create_paypal_plan",nonce:n.get("checkout_nonce"),first_name:n.get("billing_first_name"),last_name:n.get("billing_last_name"),email:n.get("billing_email"),country:n.get("billing_country"),vat_number:n.get("billing_vat_number")})})).json();if(!m.success||!m.data.plan_id)throw new Error(m.data?.message||"Failed to create PayPal plan");let w={plan_id:m.data.plan_id,application_context:{shipping_preference:"NO_SHIPPING"},subscriber:{name:{given_name:n.get("billing_first_name"),surname:n.get("billing_last_name")},email_address:n.get("billing_email")}};return c.toggleLoading(document.getElementById("loading-overlay"),!1),await v.subscription.create(w)}catch(n){throw console.error("Subscription creation error:",n),c.showMessage(document.getElementById("checkout-message"),n.message),n}}:y.createOrder=async(l,v)=>{try{if(!e)throw new Error("Checkout form not found");let n=new FormData(e),s=i.reduce((E,R)=>E+parseFloat(R.price),0),m=n.get("billing_country"),w=digicommerceVars.businessCountry,S=n.get("billing_vat_number"),F=0,f=digicommerceVars.countries||{};digicommerceVars.removeTaxes||(m===w?F=f[w]?.tax_rate||0:f[m]?.eu&&f[w]?.eu&&(!S||!window.vatCalculator?.validateVATNumber(S,m))&&(F=f[m]?.tax_rate||0));let P=s*F,B=s+P,V=0;if(digicommerceVars.cartDiscount){let E=JSON.parse(digicommerceVars.cartDiscount);E.type==="percentage"?V=B*E.amount/100:V=Math.min(E.amount,B)}let T=B-V;return v.order.create({purchase_units:[{amount:{currency_code:digicommerceVars.currency,value:T.toFixed(2),breakdown:{item_total:{currency_code:digicommerceVars.currency,value:s.toFixed(2)},tax_total:P>0?{currency_code:digicommerceVars.currency,value:P.toFixed(2)}:void 0,discount:V>0?{currency_code:digicommerceVars.currency,value:V.toFixed(2)}:void 0}},items:i.map(E=>({name:E.name,unit_amount:{currency_code:digicommerceVars.currency,value:E.price.toFixed(2)},quantity:1}))}]})}catch(n){throw console.error("Order creation error:",n),c.showMessage(document.getElementById("checkout-message"),n.message),n}},y.onApprove=async(l,v)=>{try{let n;l.orderID&&!l.subscriptionID&&(n=await v.order.capture());let s=new FormData(e),m=document.getElementById("checkout-message");c.toggleLoading(document.getElementById("loading-overlay"),!0);let w=new URLSearchParams({action:"digicommerce_process_checkout",checkout_nonce:s.get("checkout_nonce"),payment_method:"paypal",paypal_order_id:l.orderID,paypal_subscription_id:l.subscriptionID,email:s.get("billing_email"),first_name:s.get("billing_first_name"),last_name:s.get("billing_last_name"),company:s.get("billing_company"),country:s.get("billing_country"),address:s.get("billing_address"),city:s.get("billing_city"),postcode:s.get("billing_postcode"),phone:s.get("billing_phone"),vat_number:s.get("billing_vat_number")}),S=document.getElementById("subscribe_mailing_list");S&&w.append("subscribe_mailing_list",S.checked?"1":"0"),a.get("from_abandoned")==="1"&&(w.append("from_abandoned","1"),a.get("coupon")&&w.append("recovery_coupon",a.get("coupon")));let f=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:w})).json();if(f.success&&f.data.redirect)c.showMessage(m,digicommerceVars.i18n.success,!1),f.data.order_id&&localStorage.setItem("last_order_id",f.data.order_id),setTimeout(()=>{window.location.href=f.data.redirect},1500);else throw new Error(f.data?.message||"Payment processing failed")}catch(n){console.error("PayPal payment processing error:",n),c.showMessage(document.getElementById("checkout-message"),n.message),c.toggleLoading(document.getElementById("loading-overlay"),!1)}},y.onError=l=>{console.error("PayPal error:",l),c.showMessage(document.getElementById("checkout-message"),"PayPal payment failed"),c.toggleLoading(document.getElementById("loading-overlay"),!1)},y.onCancel=()=>{c.showMessage(document.getElementById("checkout-message"),"Payment cancelled"),c.toggleLoading(document.getElementById("loading-overlay"),!1)},paypal.Buttons(y).render("#paypal-button-container")}let d=document.getElementById("country");if(d){let i=new Choices(d,{searchEnabled:!0,searchPlaceholderValue:d.dataset.placeholder,searchResultLimit:-1}),t=a.get("country");t&&d.querySelector(`option[value="${t}"]`)&&(i.setChoiceByValue(t),d.value=t,setTimeout(()=>{window.vatCalculator&&window.vatCalculator.updateFromSubtotal()},0))}let _=document.querySelectorAll(".digi__form .field input");_&&_.forEach(i=>{let t=()=>{i.value!==""?i.classList.add("focused"):i.classList.remove("focused")};t(),i.addEventListener("blur",t),i.addEventListener("input",t)});let u={validateCountry:(i,t)=>i.value?!0:(t.onFailure(digicommerceVars.i18n.select_country),!1),validateRequiredFields:(i,t)=>{let o=i.querySelectorAll("input[required]"),y=!0;return o.forEach(l=>{l.value.trim()||(y=!1)}),y?!0:(t.onFailure(digicommerceVars.i18n.required_fields),!1)},validateVATNumber:(i,t,o)=>{if(!window.vatCalculator)return!0;let y=t.value,l=document.getElementById("vat_number"),v=document.getElementById("vat_number_field");if(!l||v.style.display==="none")return!0;if(window.vatCalculator.isEUCountry(y)){let n=l.value.trim();if(n&&!window.vatCalculator.validateVATNumber(n,y))return o.onFailure(digicommerceVars.i18n.vat_invalid||"Invalid VAT number format"),l.classList.add("border-red-500"),!1}return!0},validateForm:(i,t,o)=>u.validateCountry(t,o)&&u.validateVATNumber(i,t,o)&&u.validateRequiredFields(i,o)},L=document.getElementById("payment_method_stripe"),g=document.getElementById("payment_method_paypal"),h=document.querySelector(".digicommerce-stripe"),p=document.querySelector(".digicommerce-paypal"),r=document.querySelector(".digicommerce-checkout-button"),b=document.getElementById("paypal-button-container");if(L&&g&&h&&p){let i=function(t){t?(p.style.opacity="0",setTimeout(()=>{p.style.display="none",h.style.display="flex",r.style.display="flex",b.style.display="none",h.offsetWidth,h.style.opacity="1",r.style.opacity="1"},300)):(h.style.opacity="0",r.style.opacity="0",setTimeout(()=>{h.style.display="none",p.style.display="flex",r.style.display="none",b.style.display="flex",p.offsetWidth,p.style.opacity="1"},300))};var N=i;p.style.opacity="0",p.style.display="none",b.style.display="none",L.addEventListener("change",function(){this.checked&&i(!0)}),g.addEventListener("change",function(){this.checked&&i(!1)}),L.checked?(h.style.display="flex",h.style.opacity="1",r.style.display="flex",r.style.opacity="1",b.style.display="none"):g.checked&&(p.style.display="flex",p.style.opacity="1",r.style.display="none",b.style.display="flex"),h.style.transition="opacity 300ms ease-in-out",p.style.transition="opacity 300ms ease-in-out",r.style.transition="all 300ms ease-in-out"}let I=document.getElementById("loading-overlay"),C=document.getElementById("checkout-message");if(e&&d&&(digicommerceVars.stripeEnabled||digicommerceVars.paypalEnabled)){d.removeAttribute("required"),e.setAttribute("novalidate","");let i=document.getElementById("vat_number");i&&i.addEventListener("input",()=>{i.classList.remove("border-red-500"),C.classList.add("hidden")}),e.addEventListener("submit",async function(t){t.preventDefault();let o=e.querySelector("button.digicommerce-checkout-button .text"),y=o.textContent;c.toggleLoading(I,!0),o.disabled=!0,o.textContent=digicommerceVars.i18n.processing_payment;let l={onFailure:s=>{c.handleValidationFailure(C,I,o,y,s)}};if(!u.validateForm(e,d,l))return;let n=e.querySelector('input[name="billing_email"]')?.value.trim();if(!n||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)){c.handleValidationFailure(C,I,o,y,digicommerceVars.i18n.invalid_email);return}C.classList.add("hidden");try{if(k&&x){let s=new FormData(e),m=await q.handlePayment(s,x,k);if(m.success)c.showMessage(C,digicommerceVars.i18n.success,!1),m.data.order_id&&localStorage.setItem("last_order_id",m.data.order_id),setTimeout(()=>{m.data.redirect?window.location.href=m.data.redirect:digicommerceVars.payment_success_page&&(window.location.href=digicommerceVars.payment_success_page)},1500);else throw new Error(m.data?.message||digicommerceVars.i18n.payment_error)}}catch(s){console.error("Checkout Error:",s),c.showMessage(C,s.message),c.resetButton(o,y)}finally{c.toggleLoading(I,!1)}}),e.querySelectorAll("input[required]").forEach(t=>{t.addEventListener("invalid",function(o){o.preventDefault(),t.classList.add("invalid")}),t.addEventListener("input",function(){t.classList.remove("invalid")})})}});})();
