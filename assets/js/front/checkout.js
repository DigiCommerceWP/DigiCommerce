(()=>{var s={showMessage:(e,i,l=!0)=>{e.textContent=i,e.classList.remove("hidden","bg-green-500","bg-red-500"),e.classList.add(l?"bg-red-500":"bg-green-500","text-white");let u=e.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:u,behavior:"smooth"})},hideMessage:(e,i=5e3)=>{setTimeout(()=>{e.classList.add("hidden")},i)},toggleLoading:(e,i)=>{i?(e.classList.remove("hidden"),e.classList.add("flex")):(e.classList.add("hidden"),e.classList.remove("flex"))},resetButton:(e,i)=>{e.disabled=!1,e.textContent=i},handleValidationFailure:(e,i,l,p,u)=>{s.showMessage(e,u),s.toggleLoading(i,!1),s.resetButton(l,p)}},j={async handlePayment(e,i,l){try{let u=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_process_stripe_payment",nonce:e.get("checkout_nonce"),...this.getFormFields(e)})})).json();if(!u.success)throw new Error(u.data?.message||"Payment setup failed");let B={payment_method:{card:i,billing_details:this.getBillingDetails(e)}},g={customer_id:u.data.customerId},_=u.data.setupIntent!==void 0;if(u.data.setupIntent){let{setupIntent:d,error:r}=await l.confirmCardSetup(u.data.setupIntent.client_secret,B);if(r)throw new Error(r.message);g.payment_method=d.payment_method,g.setup_intent_id=d.id}if(u.data.paymentIntent){let{paymentIntent:d,error:r}=await l.confirmCardPayment(u.data.paymentIntent.client_secret,g.payment_method?{payment_method:g.payment_method}:B);if(r)throw new Error(r.message);if(g.payment_intent_id=d.id,d.status!=="succeeded")throw new Error("Payment verification failed. Please try again.")}if(g.payment_method&&_&&g.setup_intent_id){let r=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_process_stripe_payment",nonce:e.get("checkout_nonce"),stripe_payment_data:JSON.stringify(g),...this.getFormFields(e)})})).json();if(!r.success)throw new Error(r.data?.message||"Failed to create subscription");if(r.data.requiresAction&&r.data.clientSecret){let{paymentIntent:C,error:k}=await l.confirmCardPayment(r.data.clientSecret);if(k)throw new Error(k.message);g.payment_intent_id=C.id}r.data.subscriptionId&&(g.subscription_id=r.data.subscriptionId)}return await this.processCheckout(new URLSearchParams({action:"digicommerce_process_checkout",checkout_nonce:e.get("checkout_nonce"),payment_method:"stripe",stripe_payment_data:JSON.stringify(g),...this.getFormFields(e)}))}catch(p){throw console.error("Payment error:",p),p}},processCheckout(e){return fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(i=>i.json()).then(i=>{if(!i.success)throw new Error(i.data?.message||"Checkout processing failed");return i})},getBillingDetails(e){return{name:`${e.get("billing_first_name")} ${e.get("billing_last_name")}`,email:e.get("billing_email"),phone:e.get("billing_phone"),address:{line1:e.get("billing_address"),city:e.get("billing_city"),postal_code:e.get("billing_postcode"),state:e.get("billing_state"),country:e.get("billing_country")}}},getFormFields(e){let i={first_name:e.get("billing_first_name"),last_name:e.get("billing_last_name"),email:e.get("billing_email"),phone:e.get("billing_phone"),company:e.get("billing_company")||"",address:e.get("billing_address"),city:e.get("billing_city"),postcode:e.get("billing_postcode"),state:e.get("billing_state"),country:e.get("billing_country"),vat_number:e.get("billing_vat_number")||""},l=document.getElementById("subscribe_mailing_list");l&&(i.subscribe_mailing_list=l.checked?"1":"0");let p=new URLSearchParams(window.location.search);return p.get("from_abandoned")==="1"&&(i.from_abandoned="1",p.get("coupon")&&(i.recovery_coupon=p.get("coupon"))),i}},O,T;document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("digicommerce-checkout-form"),i=new URLSearchParams(window.location.search);if(e&&(digicommerceVars.stripeEnabled&&(O=Stripe(digicommerceVars.publishableKey),T=O.elements().create("card",{hidePostalCode:!0,style:{base:{fontSize:"16px",color:"#32325d",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',"::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}}),T.mount("#card-element"),T.addEventListener("change",function(t){let a=document.getElementById("card-errors");t.error?(a.textContent=t.error.message,a.classList.remove("hidden"),a.classList.add("flex")):(a.textContent="",a.classList.remove("flex"),a.classList.add("hidden"))})),digicommerceVars.paypalEnabled)){let n=JSON.parse(digicommerceVars.cartItems||"[]"),t=n.some(m=>m.subscription_enabled),a=n.filter(m=>m.subscription_enabled),h=n.filter(m=>!m.subscription_enabled),f=t?a.length===1&&h.length===0:!0,w={fundingSource:paypal.FUNDING.PAYPAL,style:{layout:"vertical",shape:"rect",label:t?"subscribe":"pay"}};t&&f?w.createSubscription=async(m,I)=>{try{if(!e)throw new Error(digicommerceVars.i18n.checkout_form_not_found);let o=new FormData(e);s.toggleLoading(document.getElementById("loading-overlay"),!0);let y=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"digicommerce_create_paypal_plan",nonce:o.get("checkout_nonce"),first_name:o.get("billing_first_name"),last_name:o.get("billing_last_name"),email:o.get("billing_email"),country:o.get("billing_country"),vat_number:o.get("billing_vat_number")})})).json();if(!y.success){let V=y.data?.message||digicommerceVars.i18n.paypal_plan_creation_failed;throw new Error(V)}if(!y.data.plan_id)throw new Error(digicommerceVars.i18n.paypal_plan_creation_failed);let L={plan_id:y.data.plan_id,application_context:{shipping_preference:"NO_SHIPPING"},subscriber:{name:{given_name:o.get("billing_first_name"),surname:o.get("billing_last_name")},email_address:o.get("billing_email")}};return s.toggleLoading(document.getElementById("loading-overlay"),!1),await I.subscription.create(L)}catch(o){throw console.error("Subscription creation error:",o),s.toggleLoading(document.getElementById("loading-overlay"),!1),s.showMessage(document.getElementById("checkout-message"),o.message),o}}:w.createOrder=x;async function x(m,I){try{if(!e)throw new Error(digicommerceVars.i18n.checkout_form_not_found);let o=new FormData(e),c=n.reduce((b,U)=>b+parseFloat(U.price),0),y=0;if(digicommerceVars.cartDiscount){let b=JSON.parse(digicommerceVars.cartDiscount);b.type==="percentage"?y=c*b.amount/100:y=Math.min(b.amount,c)}let L=c-y,V=o.get("billing_country"),R=digicommerceVars.businessCountry,S=o.get("billing_vat_number"),P=0,M=digicommerceVars.countries||{};digicommerceVars.removeTaxes||(V===R?P=M[R]?.tax_rate||0:M[V]?.eu&&M[R]?.eu&&(!S||!window.vatCalculator?.validateVATNumber(S,V))&&(P=M[V]?.tax_rate||0));let q=L*P,N=L+q;if(N<=0)throw new Error(digicommerceVars.i18n.invalid_order_total);let A={purchase_units:[{amount:{currency_code:digicommerceVars.currency,value:N.toFixed(2),breakdown:{item_total:{currency_code:digicommerceVars.currency,value:c.toFixed(2)}}},items:n.map(b=>({name:b.name+(b.variation_name?` (${b.variation_name})`:""),unit_amount:{currency_code:digicommerceVars.currency,value:parseFloat(b.price).toFixed(2)},quantity:1,category:"DIGITAL_GOODS"}))}]};return q>0&&(A.purchase_units[0].amount.breakdown.tax_total={currency_code:digicommerceVars.currency,value:q.toFixed(2)}),y>0&&(A.purchase_units[0].amount.breakdown.discount={currency_code:digicommerceVars.currency,value:y.toFixed(2)}),I.order.create(A)}catch(o){throw console.error("Order creation error:",o),s.showMessage(document.getElementById("checkout-message"),o.message),o}}w.onApprove=async(m,I)=>{try{let o;m.orderID&&!m.subscriptionID&&(o=await I.order.capture());let c=new FormData(e),y=document.getElementById("checkout-message");s.toggleLoading(document.getElementById("loading-overlay"),!0);let L=new URLSearchParams({action:"digicommerce_process_checkout",checkout_nonce:c.get("checkout_nonce"),payment_method:"paypal",paypal_order_id:m.orderID,paypal_subscription_id:m.subscriptionID,email:c.get("billing_email"),first_name:c.get("billing_first_name"),last_name:c.get("billing_last_name"),company:c.get("billing_company"),country:c.get("billing_country"),address:c.get("billing_address"),city:c.get("billing_city"),postcode:c.get("billing_postcode"),state:c.get("billing_state"),phone:c.get("billing_phone"),vat_number:c.get("billing_vat_number")}),V=document.getElementById("subscribe_mailing_list");V&&L.append("subscribe_mailing_list",V.checked?"1":"0"),i.get("from_abandoned")==="1"&&(L.append("from_abandoned","1"),i.get("coupon")&&L.append("recovery_coupon",i.get("coupon")));let S=await(await fetch(digicommerceVars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:L})).json();if(S.success&&S.data.redirect)s.showMessage(y,digicommerceVars.i18n.success,!1),S.data.order_id&&localStorage.setItem("last_order_id",S.data.order_id),setTimeout(()=>{window.location.href=S.data.redirect},1500);else{let P=S.data?.message||digicommerceVars.i18n.paypal_processing_failed;throw new Error(P)}}catch(o){console.error("PayPal payment processing error:",o);let c=o.message||digicommerceVars.i18n.paypal_processing_failed;s.showMessage(document.getElementById("checkout-message"),c),s.toggleLoading(document.getElementById("loading-overlay"),!1)}},w.onError=m=>{console.error("PayPal error:",m);let I=m?.message||digicommerceVars.i18n.paypal_failed;s.showMessage(document.getElementById("checkout-message"),I),s.toggleLoading(document.getElementById("loading-overlay"),!1)},w.onCancel=()=>{s.showMessage(document.getElementById("checkout-message"),digicommerceVars.i18n.paypal_cancelled),s.toggleLoading(document.getElementById("loading-overlay"),!1)},paypal.Buttons(w).render("#paypal-button-container");let v=document.getElementById("payment_method_paypal");v&&v.addEventListener("change",function(){if(this.checked&&!f){let m=document.getElementById("checkout-message"),I=a.length>1?digicommerceVars.i18n.multiple_subscriptions_error:digicommerceVars.i18n.mixed_cart_error;s.showMessage(m,I)}});let E=document.getElementById("payment_method_stripe");E&&E.addEventListener("change",function(){this.checked&&document.getElementById("checkout-message").classList.add("hidden")})}let l=document.getElementById("country");if(l){let n=new Choices(l,{searchEnabled:!0,searchPlaceholderValue:l.dataset.placeholder,searchResultLimit:-1}),t=i.get("country");t&&l.querySelector(`option[value="${t}"]`)&&(n.setChoiceByValue(t),l.value=t,setTimeout(()=>{window.vatCalculator&&window.vatCalculator.updateFromSubtotal()},0))}let p=document.querySelectorAll(".digi__form .field input");p&&p.forEach(n=>{let t=()=>{n.value!==""?n.classList.add("focused"):n.classList.remove("focused")};t(),n.addEventListener("blur",t),n.addEventListener("input",t)});let u={validateCountry:(n,t)=>n.value?!0:(t.onFailure(digicommerceVars.i18n.select_country),!1),validateRequiredFields:(n,t)=>{let a=n.querySelectorAll("input[required]"),h=!0;return a.forEach(f=>{f.value.trim()||(h=!1)}),h?!0:(t.onFailure(digicommerceVars.i18n.required_fields),!1)},validateVATNumber:(n,t,a)=>{if(!window.vatCalculator)return!0;let h=t.value,f=document.getElementById("vat_number"),w=document.getElementById("vat_number_field");if(!f||w.style.display==="none")return!0;if(window.vatCalculator.isEUCountry(h)){let x=f.value.trim();if(x&&!window.vatCalculator.validateVATNumber(x,h))return a.onFailure(digicommerceVars.i18n.vat_invalid||"Invalid VAT number format"),f.classList.add("border-red-500"),!1}return!0},validateForm:(n,t,a)=>u.validateCountry(t,a)&&u.validateVATNumber(n,t,a)&&u.validateRequiredFields(n,a)},B=document.getElementById("payment_method_stripe"),g=document.getElementById("payment_method_paypal"),_=document.querySelector(".digicommerce-stripe"),d=document.querySelector(".digicommerce-paypal"),r=document.querySelector(".digicommerce-checkout-button"),C=document.getElementById("paypal-button-container");if(B&&g&&_&&d){let n=function(t){t?(d.style.opacity="0",setTimeout(()=>{d.style.display="none",_.style.display="flex",r.style.display="flex",C.style.display="none",_.offsetWidth,_.style.opacity="1",r.style.opacity="1"},300)):(_.style.opacity="0",r.style.opacity="0",setTimeout(()=>{_.style.display="none",d.style.display="flex",r.style.display="none",C.style.display="flex",d.offsetWidth,d.style.opacity="1"},300))};var $=n;d.style.opacity="0",d.style.display="none",C.style.display="none",B.addEventListener("change",function(){this.checked&&n(!0)}),g.addEventListener("change",function(){this.checked&&n(!1)}),B.checked?(_.style.display="flex",_.style.opacity="1",r.style.display="flex",r.style.opacity="1",C.style.display="none"):g.checked&&(d.style.display="flex",d.style.opacity="1",r.style.display="none",C.style.display="flex"),_.style.transition="opacity 300ms ease-in-out",d.style.transition="opacity 300ms ease-in-out",r.style.transition="all 300ms ease-in-out"}let k=document.getElementById("loading-overlay"),F=document.getElementById("checkout-message");if(e&&l&&(digicommerceVars.stripeEnabled||digicommerceVars.paypalEnabled)){l.removeAttribute("required"),e.setAttribute("novalidate","");let n=document.getElementById("vat_number");n&&n.addEventListener("input",()=>{n.classList.remove("border-red-500"),F.classList.add("hidden")}),e.addEventListener("submit",async function(t){t.preventDefault();let a=e.querySelector("button.digicommerce-checkout-button .text"),h=a.textContent;s.toggleLoading(k,!0),a.disabled=!0,a.textContent=digicommerceVars.i18n.processing_payment;let f={onFailure:v=>{s.handleValidationFailure(F,k,a,h,v)}};if(!u.validateForm(e,l,f))return;let x=e.querySelector('input[name="billing_email"]')?.value.trim();if(!x||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(x)){s.handleValidationFailure(F,k,a,h,digicommerceVars.i18n.invalid_email);return}F.classList.add("hidden");try{if(O&&T){let v=new FormData(e),E=await j.handlePayment(v,T,O);if(E.success)s.showMessage(F,digicommerceVars.i18n.success,!1),E.data.order_id&&localStorage.setItem("last_order_id",E.data.order_id),setTimeout(()=>{E.data.redirect?window.location.href=E.data.redirect:digicommerceVars.payment_success_page&&(window.location.href=digicommerceVars.payment_success_page)},1500);else throw new Error(E.data?.message||digicommerceVars.i18n.payment_error)}}catch(v){console.error("Checkout Error:",v),s.showMessage(F,v.message),s.resetButton(a,h)}finally{s.toggleLoading(k,!1)}}),e.querySelectorAll("input[required]").forEach(t=>{t.addEventListener("invalid",function(a){a.preventDefault(),t.classList.add("invalid")}),t.addEventListener("input",function(){t.classList.remove("invalid")})})}});})();
